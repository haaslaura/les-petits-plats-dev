import{chooseOptions}from"../utils/chooseOptions.min.js";export class DropdownManager{constructor(t,e,o,s){this.id=t,this.dataArray=e,this.dataKey=o,this.filterOptions=s,this.uniqueItems=new Set,this.itemsArray=[],this.capitalizedItemsArray=[],this.currentIndex=-1,this.dropdown=document.getElementById(`${this.id}`),this.dropdownBtn=document.querySelector(`#${this.id} .dropdown-btn-filter`),this.combobox=document.querySelector(`#${this.id} .option-list`),this.dropdownInput=document.querySelector(`#${this.id} .form-control`),this.dropdownElement=document.querySelector(`#${this.id} ul`),this.collectUniqueItems(),this.initializeEventListeners()}collectUniqueItems(t){const e=t||this.dataArray;this.uniqueItems=new Set,e.forEach((t=>{if(t?.[this.dataKey])switch(typeof t[this.dataKey]){case"object":t[this.dataKey].forEach((t=>{t?.ingredient?this.uniqueItems.add(t.ingredient.toLowerCase()):this.uniqueItems.add(t.toLowerCase())}));break;case"string":this.uniqueItems.add(t[this.dataKey].toLowerCase());break;default:console.log("Erreur, format de données non pris en compte")}})),this.convertItemsToArray()}convertItemsToArray(){this.itemsArray=Array.from(this.uniqueItems),this.capitalizeItems()}capitalizeItems(){this.capitalizedItemsArray=this.itemsArray.map((t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase())).sort(),this.renderDropdownItems(this.capitalizedItemsArray)}renderDropdownItems(t){this.dropdownElement.innerHTML="",t.forEach((t=>{const e=document.createElement("li");e.setAttribute("role","option"),e.setAttribute("tabindex","-1"),e.classList.add("dropdown-item","d-flex","flex-wrap","align-items-center","py-2"),e.textContent=`${t}`,this.dropdownElement.appendChild(e)})),chooseOptions(this.dataArray,this.filterOptions,this.id)}comboboxAutocomplete(){const t=this.dropdownInput.value.trim().toLowerCase(),e=[];let o=0;if(t.length>0){const s=new RegExp(t,"gi");this.capitalizedItemsArray.forEach((t=>{s.test(t)&&(o=e.push(t))})),o>0?this.renderDropdownItems(e):this.dropdownElement.innerHTML="Aucun élément ne correspond"}else this.collectUniqueItems(this.dataArray)}dropdownOpen(){this.dropdown.setAttribute("aria-expanded","true"),this.dropdownBtn.setAttribute("aria-expanded","true"),this.combobox.style.maxHeight="280px",this.combobox.style.opacity="1",this.dropdownBtn.querySelector(".arrow-icon").setAttribute("src","assets/icones/arrow-up.svg"),this.dropdownInput.setAttribute("tabindex","0")}dropdownClose(){this.dropdown.setAttribute("aria-expanded","false"),this.dropdownBtn.setAttribute("aria-expanded","false"),this.combobox.style.maxHeight="0",this.combobox.style.opacity="0",this.dropdownBtn.querySelector(".arrow-icon").setAttribute("src","assets/icones/arrow-down.svg"),this.dropdownInput.setAttribute("tabindex","-1")}toggleDropdown(){"true"===this.dropdownBtn.getAttribute("aria-expanded")?this.dropdownClose():this.dropdownOpen()}isTouchScreen(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}browseOptions(t){const e=this.dropdownElement.querySelectorAll('[role="option"]');switch(t.key){case"Backspace":case"Delete":this.comboboxAutocomplete();break;case"ArrowDown":t.preventDefault(),this.currentIndex<e.length-1?this.currentIndex+=1:this.currentIndex=0,console.log(this.currentIndex),e[this.currentIndex].focus();break;case"ArrowUp":t.preventDefault(),this.currentIndex>0?this.currentIndex-=1:this.currentIndex=e.length-1,console.log(this.currentIndex),e[this.currentIndex].focus();break;case"Escape":this.combobox.setAttribute("aria-expanded","false"),this.dropdownInput.focus()}}initializeEventListeners(){this.dropdown.addEventListener("new-filter",(t=>{this.collectUniqueItems(t.detail)})),this.isTouchScreen()?(this.dropdownBtn.addEventListener("click",this.toggleDropdown.bind(this)),document.addEventListener("click",(t=>{this.dropdown.contains(t.target)||this.dropdownClose()}))):(this.dropdown.addEventListener("mouseover",this.dropdownOpen.bind(this)),this.dropdown.addEventListener("mouseout",this.dropdownClose.bind(this)),this.dropdownBtn.addEventListener("keydown",(t=>{"Enter"===t.key&&this.toggleDropdown(),"Escape"===t.key&&this.dropdownClose()}))),this.dropdownInput.addEventListener("input",this.comboboxAutocomplete.bind(this)),this.dropdownInput.addEventListener("keydown",(t=>{this.browseOptions(t)}))}}